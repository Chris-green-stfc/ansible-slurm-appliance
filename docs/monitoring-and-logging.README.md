# Monitoring and logging configuration

## Components overview

### [filebeat](https://www.elastic.co/beats/filebeat)

Parses log files and ships them elasticsearch. Note we use the version shipped by Open Distro.

### [grafana](https://grafana.com/)

Visualisation tool that supports multiple different datasources. In our stack,
we use it to visualise prometheus and elasticsearch data.

### [kibana](https://www.elastic.co/kibana)

Visualisation tool for elasticsearch. Provides a web interface to query elasticsearch.

### [opendistro](https://opendistro.github.io/)

An open-source distribution of elasticsearch. Elasticsearch is a search engine that provides full
text search over a collection of JSON documents. In this project, the main use is for the archiving
and retrieval of log files.

### [prometheus](https://prometheus.io/)

Stores metrics in a time series database and makes them available via the Prometheus Query Language (PromQL).
Metrics are scraped from exporters. Exporters are services which expose HTTP endpoints that prometheus will periodically scrape to harvest new metrics.

### [slurm-stats](https://github.com/stackhpc/slurm-openstack-tools)

Tool which parses slurm accounting data and produces a log file that is suitable for ingest by filebeat.

## Customising variables

You should only customise the variables in `environments/common` if you are working on a feature that you intend to contribute back. Instead you should override the variables in the environment relevant to your deployment. This is possible since inventories later in the inheritance chain have greater precedence. Please see `README.md` for a more detailed explanation. This notice exists to avoid the need to need to keep repeating this point in the following sections. Where it is noted that you should customise a variable, it is implied that this change should be made to your own environment e.g `environments/production` in preference to `environments/common`, even when
this is not explicitly stated.

## filebeat

This section details the configuration of grafana.

## grafana

This section details the configuration of grafana.

### grafana dashboards

## kibana

This section details the configuration of kibana.

## opendistro

This section details the configuration of Open Distro. Variables referenced in this section can be found in:

> environments/common/inventory/group_vars/all/opendistro.yml

The role used to configure the service is internal. The path of the role relative to repository root is:

> ansible/roles/opendistro

The variables that intended to be customisable are defined in:

> ansible/roles/opendistro/defaults/main.yml

### Users

The default set of users is defined in:

> environments/common/files/opendistro/internal_users.yml

This defines an the following accounts:

| username      |  password                                     | purpose                                   |
| ------------- | --------------------------------------------- |-------------------------------------------|
| admin         | secrets_openhpc_elasticsearch_admin_password  | User of highest privilege                 |
| kibanaserver  | secrets_openhpc_elasticsearch_kibana_password | Internal kibana user (not currently used) |

Where the password field refers to a variable containing the actual password. These are generated by the
`generate-passwords.yml` adhoc playbook (see README.md).

The admin account can be used to add additional users via the kibana UI. As the account has full admin privileges
the credentials should be treated with extreme care.

To override the default set of users, you can customize the variable:

> environments/common/files/opendistro/internal_users.yml

You can change this file by modifying the variable, `opendistro_internal_users_path`, where the default can be
found in:

> environments/common/inventory/group_vars/all/opendistro.yml

## Prometheus

This section details the configuration of prometheus. Internally, we use the [cloudalchemy.prometheus](https://github.com/cloudalchemy/ansible-prometheus) role. You can customise any of the variables that the role supports. For a full list, please see the
[upstream documentation](https://github.com/cloudalchemy/ansible-prometheus).

## Recording rules

The upstream documentation can be found [here](https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/).

This appliance provides a default set of recording rules which can be found here:

> environments/common/files/prometheus/rules/precompute.rules

The intended purpose is to pre-compute some expensive queries that are used
in the reference set of grafana dashboards.

To add new, or to remove rules you will be to adjust the `prometheus_alert_rules_files` variable. The default value can be found in:

> environments/common/inventory/group_vars/all/prometheus.yml

You can extend this variable in your environment specific configuration to reference extra files or to remove the defaults. The reference set of dashboards expect these variables to be defined, so if you remove them, you
will also have to update your dashboards.

### [node_exporter](https://github.com/prometheus/node_exporter)

Collects OS level metrics such as CPU usage, Memory usage, and IO statistics. The metrics that
are collected can be controlled by enabling different sets of collectors. For a full list
of collectors that are available, see the upstream documentation.

This appliance customises the default set of collectors to a minimal set, these are:

- netdev
- cpu
- meminfo
- infiniband
- cpufreq

The list can be customised by overriding the `collect[]` parameter of the `node` job in the `prometheus_scrape_configs` dictionary. The defaults can be found in:

> environments/common/inventory/group_vars/all/prometheus.yml

Variables in this file should *not* be customised directly, but should be overriden in your `environment`. See `README.md` which details the process of overriding default variables in more detail.

## slurm-stats

Currently there is no customisation of this role in the common environment i.e we are just using role defaults. It is possible to override these by setting the relevant variable in your environment config. See [here](https://github.com/stackhpc/ansible_collection_slurm_openstack_tools/tree/main/roles/slurm-stats) for a list of variables that can be set.





