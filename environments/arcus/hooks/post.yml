- hosts: login:!builder # won't have a slurm control daemon when in build
  become: no
  gather_facts: false
  tasks:
    - name: Check slurm up after direct deploy
      import_tasks: check_slurm.yml

- hosts: control:!builder
  become: yes
  gather_facts: false
  tasks:
    - name: Write CI-generated secrets for debugging
      ansible.builtin.copy:
        dest: /etc/ci-secrets.txt
        content: |
          vault_elasticsearch_admin_password: {{ vault_elasticsearch_admin_password }}
          vault_grafana_admin_password: {{ vault_grafana_admin_password }}
          vault_mysql_root_password: {{ vault_mysql_root_password }}
          test_user_password: {{ test_user_password }}
      no_log: true

- hosts: localhost
  become: false
  tags: build
  tasks:
    - name: Check Packer build finished
      async_status:
        jid: "{{ packer_run.ansible_job_id }}"
      register: packer_result
      until: packer_result.finished
      retries: 30 # allow 15 mins
      delay: 30
      when: packer_run is defined # allows rerunning post.yml
