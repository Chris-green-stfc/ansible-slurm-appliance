---
## TODO: maybe we should arrange it following the osc.github.io docs
## TODO: Note variables prefixed ood_ are all from https://github.com/OSC/ood-ansible but in some case the prefix is added here - if overriding in an environment use the ood_ version.

user_map_cmd: "{{ '/opt/ood/ood_auth_map/bin/ood_auth_map.mapfile' if openondemand_mapping_users else omit }}"

# Enable SSL by default:
ood_httpd_port: 443 # osc.ood:httpd_port
# Use self-signed certs generated by the mod_ssl package installed by ondemand-apache:
ood_ssl_cert: /etc/pki/tls/certs/localhost.crt # osc.ood:ssl_cert
ood_ssl_cert_key: /etc/pki/tls/private/localhost.key # osc.ood:ssl_cert_key
ood_ssl:
  - "SSLCertificateFile {{ ssl_cert }}"
  - "SSLCertificateKeyFile {{ ssl_cert_key }}"
  # following based on https://grok.lsu.edu/article.aspx?articleid=17596
  - SSLProtocol all -TLSv1.1 -TLSv1 -SSLv2 -SSLv3
  - SSLCipherSuite ALL:+HIGH:!ADH:!EXP:!SSLv2:!SSLv3:!MEDIUM:!LOW:!NULL:!aNULL
  - SSLHonorCipherOrder On
  - SSLCompression off
  - SSLSessionTickets Off

# TODO: consider adding other defaults from here for good security by default:
# https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-apache-in-ubuntu-16-04
ood_clusters: # osc.ood:clusters - see https://github.com/OSC/ood-ansible#clusters
  slurm:
    v2:
      metadata:
        title: "{{ openhpc_cluster_name }}" # interpolation here works as openondemand is lexically after openhpc
      login:
        host: "{{ ansible_default_ipv4.address }}" # TODO: should be specific interface of first LOGIN node - by default
        default: true
      job:
        adapter: slurm
        cluster: "{{ openhpc_cluster_name }}"
      batch_connect:
        basic:
          script_wrapper: |
            module purge
            %s
          set_host: host=$(hostname -s)
        vnc: # TODO: check/fix
          script_wrapper: |
            module purge
            export PATH=/opt/TurboVNC/bin:$PATH
            export WEBSOCKIFY_CMD=/bin/websockify

            # Workaround to avoid "Unable to contact settings server" when
            # lauching xfce4-session
            xfce4-session() { /bin/dbus-launch /bin/xfce4-session $@ ; }
            export -f xfce4-session
            %s
          set_host: host=$(hostname -s)
          # TODO: add grafana in here - see https://osc.github.io/ood-documentation/latest/customization.html#grafana-support

ood_apps: # osc.ood:ood_apps - see https://github.com/OSC/ood-ansible#ood_apps
  bc_desktop:             # TODO: get this working
    title: Remote Desktop
    description: |
      Request a desktop to run GUI applications.
    cluster: "{{ openhpc_cluster_name }}"
    form:
      - desktop
      - bc_account
      - bc_queue
      - bc_num_hours
      - num_cores
      - bc_email_on_started
      - bc_num_slots
      - node
    attributes:
      desktop: xfce
      bc_account:
        value: root
      bc_queue:
        value: compute
      num_cores:
        min: 1
      node: ""
    submit: |
      ---
      script:
        native:
          - <%= "--nodes=#{bc_num_slots}" %>
          - <%= "--ntasks=#{num_cores}" %>
          - <%= "--nodelist=#{node}" %>
  files:
    env:
      ood_shell: ""
  shell:
    env:
      ood_shell_origin_check: "off" # "http://{{ openondemand_servername }}"
  dashboard:
    env:
      motd_path: /etc/motd
      motd_format: markdown
      ood_dashboard_support_url: "{{ openondemand_dashboard_support_url }}"
      ood_dashboard_docs_url: "{{ openondemand_dashboard_docs_url }}"
      ood_brand_bg_color: "#0e6ec8"
      ood_dashboard_title: "{{ openhpc_cluster_name }}"
      ood_dashboard_logo: /var/www/ood/public/logo.png
      ood_dashboard_headr_img_logo: /var/www/ood/public/logo.png
      ood_dashboard_logo_height: 200px